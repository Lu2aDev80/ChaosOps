name: CI/CD Pipeline

on:
  push:
    branches:
      - master
      - main

permissions:
  contents: read
  packages: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Create .env.production file
      run: |
        cat << EOF > .env.production
        DATABASE_URL=postgresql://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@postgres:5432/${{ vars.POSTGRES_DB }}?schema=public
        POSTGRES_USER=${{ secrets.POSTGRES_USER }}
        POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
        POSTGRES_DB=${{ vars.POSTGRES_DB }}
        SMTP_HOST=${{ vars.SMTP_HOST }}
        SMTP_PORT=${{ vars.SMTP_PORT }}
        SMTP_USER=${{ secrets.SMTP_USER }}
        SMTP_PASS=${{ secrets.SMTP_PASS }}
        SMTP_SECURE=false
        SMTP_IGNORE_TLS=false
        SMTP_REQUIRE_TLS=true
        SMTP_REJECT_UNAUTHORIZED=false
        MAIL_FROM_NAME=${{ vars.MAIL_FROM_NAME }}
        MAIL_FROM_EMAIL=${{ vars.MAIL_FROM_EMAIL }}
        LOG_LEVEL=info
        PRISMA_LOG=warn
        APP_BASE_PATH=
        NODE_ENV=production
        FRONTEND_HOST=${{ vars.FRONTEND_HOST }}
        EOF

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/konfidayplaner:latest
          ${{ secrets.DOCKER_USERNAME }}/konfidayplaner:${{ github.sha }}

    - name: Deployment Info
      run: |
        echo "‚úÖ Image pushed to Docker Hub"
        echo "üì¶ Image: ${{ secrets.DOCKER_USERNAME }}/konfidayplaner:latest"
        echo "üîÑ Watchtower on the server will automatically update the container within 5 minutes"
        echo "üåê URL: https://chaos-ops.de"
